#!/usr/bin/env node
/**
 * Generate lib/tampermonkey-editor-typings.generated.ts from preset/src/editor-typings.d.ts.
 * Run by build:preset and postinstall so Next.js can import typings without resolving preset paths.
 * Do not edit the generated file.
 */

import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const repoRoot = path.resolve(__dirname, '..')
const sourcePath = path.join(repoRoot, 'preset/src/editor-typings.d.ts')
const outDir = path.join(repoRoot, 'lib')
const outPath = path.join(outDir, 'tampermonkey-editor-typings.generated.ts')

const content = fs.readFileSync(sourcePath, 'utf8')
const escaped = content.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$\{/g, '\\${')

if (!fs.existsSync(outDir)) {
  fs.mkdirSync(outDir, { recursive: true })
}

const output = `/**
 * Generated by scripts/generate-editor-typings.mjs from preset/src/editor-typings.d.ts.
 * Do not edit. Run "pnpm run generate:editor-typings" or "pnpm run build:preset" to regenerate.
 */

export const editorTypingsSource = \`${escaped}\`
`

fs.writeFileSync(outPath, output, 'utf8')
