# Tampermonkey UserScript Core Template (`gm-template`)

这个目录包含了项目的核心油猴脚本模版。它不是一个标准的 Web 项目模块，而是运行在浏览器油猴插件环境中的核心桥接代码。

## 背景与初衷

在开发复杂的油猴脚本时，经常面临以下痛点：

1. **更新滞后**：每次修改代码都需要手动在油猴中粘贴更新。
2. **缺乏调试手段**：难以实现类似现代 Web 开发的 HMR（热更新）。
3. **多模块管理**：一个脚本通常由多个逻辑文件组成，难以在油猴单一编辑器中维护。

`gm-template` 正是为了解决这些问题而设计的。它作为一个高度集成的“母脚本”，负责加载、调试和运行具体的业务逻辑脚本。

## 核心作用

1. **环境桥接**：封装了油猴特有的 `GM_*` API，为子脚本提供统一的调用界面。
2. **多模式运行**：
   - **远程模式**：通过 Gist 或指定的 URL 加载生产环境脚本。
   - **本地开发模式 (Local Dev Mode)**：通过浏览器的 `showDirectoryPicker` API 直接读取本地文件系统，实现零延迟开发。
   - **编辑器开发模式 (Editor Dev Mode)**：配合项目内置的 Web 编辑器，实现云端编写、本地即时生效。
3. **规则引擎**：内置 URL 通配符匹配逻辑，根据当前访问的页面决定加载哪些业务脚本。
4. **沙箱隔离**：利用 `Function` 构造函数和 `with` 语句，为每个子脚本创建独立的执行空间，同时注入预定义的全局变量和依赖。

## 主要特性

- **WebSocket HMR**：支持通过 WebSocket 监听服务端变更并自动重载。
- **冲突处理**：集成了 IndexedDB 缓存机制，能够智能处理本地草稿与远程 Gist 的同步冲突。
- **自动化 Meta 管理**：自动处理 UserScript Header（如 `@match`, `@grant` 等）的解析与合并。
- **跨标签通信**：使用 `BroadcastChannel` 协调多个标签页之间的开发状态同步。

## 为什么需要这个模块？

这个模块是本项目“油猴集成开发环境”的基石。与常规的 Web 模块不同：

- 它需要处理大量只有在油猴环境下才存在的 API。
- 它必须保持轻量且自包含，因为它会被编译并注入到用户的脚本管理器中。
- 它承载了本项目最核心的“热更新”能力，使得油猴脚本开发体验接近于传统的 React/Vue 开发。
